{% extends "base.html" %}

{% block title %}{{ competition.name }} - Votación{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-10">
        <h1 class="text-3xl font-bold text-uca-blue mb-2">{{ competition.name }}</h1>
        <p class="text-xl text-gray-700 mb-2">¿Qué videos te gustaron más?</p>
        <p class="text-sm text-gray-500">Seleccioná exactamente 3 opciones</p>
    </div>

    {% if has_voted %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
        <svg class="w-16 h-16 text-uca-blue mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h2 class="text-2xl font-semibold text-uca-blue mb-2">¡Gracias por votar!</h2>
        <p class="text-gray-600">Ya votaste en esta competencia</p>
    </div>
    {% else %}
    <div id="vote-form" x-data="{ selectedCandidates: [], submitting: false }">
        {% if candidates %}
        <div class="space-y-3 mb-8">
            {% for candidate in candidates %}
            <label class="block cursor-pointer">
                <div class="border-2 rounded-lg p-5 transition-all duration-200"
                     :class="selectedCandidates.includes({{ candidate.id }}) ? 'border-uca-blue bg-blue-50' : 'border-gray-200 hover:border-gray-300'">
                    <div class="flex items-center">
                        <input type="checkbox"
                               name="candidate"
                               value="{{ candidate.id }}"
                               @change="toggleCandidate({{ candidate.id }})"
                               :checked="selectedCandidates.includes({{ candidate.id }})"
                               :disabled="!selectedCandidates.includes({{ candidate.id }}) && selectedCandidates.length >= 3"
                               class="w-5 h-5 text-uca-blue focus:ring-uca-blue rounded disabled:opacity-50">
                        <span class="ml-4 text-lg text-gray-800">{{ candidate.name }}</span>
                    </div>
                </div>
            </label>
            {% endfor %}
        </div>

        <div class="text-center mb-4">
            <p class="text-sm text-gray-600 mb-4">
                <span x-text="selectedCandidates.length"></span> de 3 seleccionados
            </p>
            <button type="button"
                    @click="submitVote()"
                    :disabled="selectedCandidates.length !== 3 || submitting"
                    class="px-8 py-3 bg-uca-blue text-white font-semibold rounded-lg hover:bg-opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <span x-show="!submitting">Enviar Voto</span>
                <span x-show="submitting">Enviando...</span>
            </button>
        </div>

        <div id="message" class="mt-6 text-center hidden">
            <div class="inline-block bg-green-50 border border-green-200 text-green-800 px-6 py-3 rounded-lg">
                <span id="message-text"></span>
            </div>
        </div>

        <script>
            function toggleCandidate(candidateId) {
                const component = Alpine.$data(document.getElementById('vote-form'));
                const index = component.selectedCandidates.indexOf(candidateId);

                if (index > -1) {
                    component.selectedCandidates.splice(index, 1);
                } else {
                    if (component.selectedCandidates.length < 3) {
                        component.selectedCandidates.push(candidateId);
                    }
                }
            }

            function submitVote() {
                const component = Alpine.$data(document.getElementById('vote-form'));
                if (component.selectedCandidates.length !== 3) return;

                component.submitting = true;

                fetch('{{ url_for("submit_vote", slug=competition.slug) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        candidate_ids: component.selectedCandidates
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('message-text').textContent = data.message;
                        document.getElementById('message').classList.remove('hidden');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        alert(data.error || 'Error al enviar el voto');
                        component.submitting = false;
                    }
                })
                .catch(error => {
                    alert('Error al enviar el voto');
                    component.submitting = false;
                });
            }
        </script>
        {% else %}
        <div class="text-center py-12 bg-gray-50 rounded-lg">
            <p class="text-gray-600 text-lg">No hay candidatos disponibles en esta competencia</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
